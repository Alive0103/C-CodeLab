# 认证系统修改说明

## 修改概述

已成功将JWT认证系统改为简单的数据库字段校验方式，并添加了密码加盐功能。

## 主要修改内容

### 1. 移除JWT相关代码
- 删除了 `JwtTokenProvider.java`
- 删除了 `JwtAuthenticationFilter.java` 
- 删除了 `InfrastructureAuthUserDetailsService.java`
- 删除了 `TokenResponse.java` DTO
- 从 `pom.xml` 中移除了JWT依赖

### 2. 添加密码加盐功能
- 在 `User` 实体中添加了 `passwordSalt` 字段
- 创建了 `PasswordUtils` 工具类，提供：
  - `generateSalt()`: 生成随机盐
  - `hashPassword()`: 使用盐对密码进行哈希
  - `verifyPassword()`: 验证密码

### 3. 修改认证服务
- `AuthService` 现在使用数据库字段校验
- `register()` 方法：生成盐值，使用盐+密码进行哈希
- `authenticate()` 方法：验证用户名密码，返回用户对象

### 4. 更新安全配置
- `SecurityConfig` 移除了JWT相关配置
- 使用Session-based认证
- 配置了formLogin和logout

### 5. 修改Controller
- `AuthController`: 使用HttpSession存储用户信息
- `CodeController`: 从Session获取用户信息
- `ResultController`: 从Session获取用户信息

### 6. 更新WebSocket认证
- `ExecutionWebSocketHandler`: 简化认证逻辑，通过URL参数传递用户名

### 7. 数据库Schema更新
- 在 `user` 表中添加了 `password_salt` 字段
- 更新了初始化数据，为现有用户添加盐值

## 新的认证流程

### 注册流程
1. 用户提交用户名、密码、邮箱
2. 系统生成随机盐值
3. 使用盐+密码进行BCrypt哈希
4. 将用户名、哈希密码、盐值、邮箱保存到数据库

### 登录流程
1. 用户提交用户名、密码
2. 系统根据用户名查询用户信息
3. 使用存储的盐值+用户输入的密码进行哈希
4. 比较哈希结果与存储的密码哈希
5. 验证成功后，将用户信息存储到Session中

### 访问控制
- 所有需要认证的接口都从HttpSession中获取用户信息
- 未登录用户访问受保护接口返回401错误

## 安全特性

1. **密码加盐**: 每个用户都有唯一的盐值，防止彩虹表攻击
2. **BCrypt哈希**: 使用BCrypt算法进行密码哈希，强度为12
3. **Session管理**: 使用HttpSession管理用户状态
4. **随机盐生成**: 使用SecureRandom生成24字节随机盐

## API变更

### 认证接口
- `POST /api/auth/register`: 注册（返回成功消息，不再返回token）
- `POST /api/auth/login`: 登录（返回用户信息，不再返回token）
- `POST /api/auth/logout`: 登出（清除Session）
- `GET /api/user`: 获取当前用户信息（从Session获取）

### 其他接口
- 所有需要认证的接口现在都使用HttpSession进行用户验证
- 请求头不再需要Authorization Bearer token

## 注意事项

1. 前端需要适配新的认证方式，不再使用JWT token
2. 需要确保前端在请求时携带Session Cookie
3. WebSocket连接需要传递用户名参数
4. 生产环境建议使用HTTPS保护Session Cookie

## 测试建议

1. 测试用户注册功能
2. 测试用户登录功能  
3. 测试登录后的接口访问
4. 测试登出功能
5. 测试未登录用户访问受保护接口

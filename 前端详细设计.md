# 前端详细设计（C-CodeLab）

## 1. 技术栈与总体架构
- 框架：Vue 3（Composition API）
- 路由：Vue Router 4
- 状态管理：Pinia
- UI：轻量自定义样式 + 可选 Element Plus（按需引入）
- 编辑器：Monaco Editor（语言：c）
- 网络：Axios（拦截器注入 JWT）
- 实时通信：WebSocket（/ws/execution-result）
- 构建：Vite

前端为单页应用（SPA），采用“登录 → 编辑器主界面”的双路由结构。核心模块包括认证、代码编辑器、结果展示、代码片段历史与执行记录。

## 2. 路由与页面结构
- `/login`
  - 用途：用户登录/注册。
  - 组件：`LoginView.vue`。
- `/editor`
  - 用途：在线 C 代码编辑、运行与结果展示。
  - 组件：`EditorView.vue`（包含编辑器、运行区、历史侧栏）。

路由守卫：
- 访问`/editor`时需校验本地是否存在有效 `accessToken`，无则跳转 `/login`（匿名模式可放行但降级能力）。

## 3. 目录结构（建议）
```
src/
  api/                // Axios 实例与 API 封装
    auth.ts          // 登录/注册/用户信息
    code.ts          // 保存/运行/执行记录
  components/
    EditorPane.vue   // Monaco Editor 包装
    OutputPane.vue   // 结果展示（stdout/stderr）
    HistoryList.vue  // 代码片段/执行记录列表
  stores/
    auth.ts          // 用户与令牌
    code.ts          // 当前代码、标题、运行状态
  views/
    LoginView.vue
    EditorView.vue
  utils/
    websocket.ts     // WS 封装与事件分发
    highlight.ts     // 错误高亮辅助（按行/列）
  styles/
    index.css
  main.ts
  router.ts
```

## 4. 状态管理（Pinia）
- `authStore`
  - state：`user{id,username,role}`, `accessToken`, `refreshToken`
  - actions：`login()`, `register()`, `logout()`, `fetchUser()`
  - 持久化：`accessToken`/`refreshToken` 存于 `localStorage`
- `codeStore`
  - state：`title`, `code`, `language='c'`, `running`, `lastResult{success,output,error,exitCode}`
  - actions：`saveSnippet()`, `runCode()`, `loadHistory()`, `applyHistoryItem()`

## 5. 网络层设计
- Axios 实例配置：
  - `baseURL`：后端网关，例如 `/api`
  - 请求拦截器：若存在 `accessToken`，注入 `Authorization: Bearer <token>`
  - 响应拦截器：统一错误提示；401 触发登出或尝试刷新令牌（可选）

- API 统一路径（与总体设计对齐）：
  - 认证：
    - `POST /api/auth/register`
    - `POST /api/auth/login`
    - `GET  /api/user`（获取当前用户）
  - 代码：
    - `POST /api/code/save`
    - `POST /api/code/run`
    - `GET  /api/result/list`
  - WebSocket：`/ws/execution-result`（握手时带 `Authorization` 头）

示例 API 封装：
```ts
// api/auth.ts
import { http } from './http';
export const login = (data:{username:string;password:string}) => http.post('/auth/login', data);
export const register = (data:{username:string;password:string;email?:string}) => http.post('/auth/register', data);
export const getUser = () => http.get('/user');
```

```ts
// api/code.ts
import { http } from './http';
export const saveSnippet = (data:{title:string;codeContent:string;language:'c';isPublic:boolean}) => http.post('/code/save', data);
export const runCode = (data:{code:string;title?:string}) => http.post('/code/run', data);
export const listResults = () => http.get('/result/list');
```

## 6. 组件设计
- `EditorPane.vue`
  - 负责创建与销毁 Monaco 实例，暴露 `getValue()/setValue()` 方法。
  - 关键配置：`language:'c'`, `theme:'vs-dark'`, `autoIndent:'full'`, 字体、Tab 宽度等。
  - 错误高亮：根据编译错误的行列信息创建 `monaco.editor.setModelMarkers`。
- `OutputPane.vue`
  - 展示运行结果：`stdout`、`stderr`、`exitCode`。
  - 失败时突出显示错误，支持复制。
- `HistoryList.vue`
  - 展示代码片段或执行记录；点击应用到编辑器。
  - 支持筛选与分页（前端分页，后续可后端分页）。

## 7. 页面交互流程
- 登录：
  1) 用户输入用户名/密码 → 调用 `POST /api/auth/login`。
  2) 成功：存储令牌，获取 `GET /api/user`，跳转 `/editor`。

- 编辑与运行：
  1) 用户在 `EditorPane` 编写代码。
  2) 点击“运行”：
     - 若需要保存则先 `POST /api/code/save`（可选）。
     - 调用 `POST /api/code/run`。
     - 通过 WebSocket 订阅实时结果推送；若无 WS，则回退使用请求响应结果。

- 历史与记录：
  1) 进入页面拉取 `GET /api/result/list`。
  2) 点击某条记录可回填代码或仅查看输出。

## 8. WebSocket 设计
- 连接：`new WebSocket(baseWsUrl + '/ws/execution-result')`；
  - 握手头：在子协议或自定义头中附带 `Authorization: Bearer <token>`（后端解析）。
- 消息：后端推送 `ExecutionResult` JSON：
  - `{ success:boolean, output:string, error:string, exitCode:number }`
- 断线重连：指数退避重连（最大间隔 30s），页面隐藏时暂停，显示时恢复。

## 9. 可靠性与体验
- 防抖与节流：运行按钮 1 秒节流，避免重复提交。
- 输入限制：前端限制代码长度 ≤ 10KB，与后端一致。
- 状态提示：`running` 态时禁用按钮与显示加载动画。
- 错误高亮：解析 gcc 错误 `file.c:LINE:COL: error: ...` 定位到编辑器对应行列。
- 本地草稿：在 `localStorage` 以 SHA-256 作为 Key 持久化草稿，防止刷新丢失。

## 10. 安全
- 令牌存储：`accessToken` 存 `localStorage`；必要时配合刷新令牌策略（后续扩展）。
- XSS：渲染输出时进行转义；仅以纯文本展示，不执行。
- CSRF：主要为 Bearer Token + 同源策略；跨域环境下使用 `withCredentials=false`。

## 11. 可观测性
- 基础埋点：运行按钮点击、运行结果（成功/失败）、耗时区间。
- 错误上报：Axios 拦截器捕获请求错误与后端错误码，统一提示与上报。

## 12. 与后端契约（对齐总体设计）
- 统一 `/api` 前缀；字段命名以 `camelCase`。
- 主要 DTO：
  - 登录成功响应：`{ code, message?, data:{ accessToken, refreshToken? } }`
  - 用户信息：`{ id, username, avatarUrl?, createdAt, email?, role }`
  - 运行响应/推送：`{ success, output, error, exitCode }`

## 13. 未来扩展
- 匿名登录：无令牌进入编辑器，以受限能力运行（频控、不可保存）。
- 多因子认证：登录二次校验。
- 代码沙箱：前端适配沙箱状态展示与资源用量提示。


# 后端详细设计（C-CodeLab）

## 1. 技术选型与总体架构
- 运行时与框架：Java 17 + Spring Boot 3.x
- 安全：Spring Security 6 + JWT（jjwt）
- Web：Spring MVC（RESTful API） + Spring WebSocket
- 数据访问：Spring Data JPA（MySQL/TiDB）
- 缓存与消息：Redis（Lettuce）
- 异步：`@Async` + `ThreadPoolTaskExecutor` + `CompletableFuture`
- 构建与依赖：Maven

分层架构：Controller → Service → Repository → Domain；横切：Security、Validation、Logging、Exception Handling。

## 2. 模块划分
- 认证授权模块（Auth）：登录、注册、令牌签发/校验、匿名用户（可选）
- 代码处理模块（Code）：代码保存、编译执行、结果推送
- 执行记录模块（Result）：历史记录查询
- 基础设施模块（Infra）：数据存储、缓存、异步线程池、全局异常处理、WebSocket

## 3. 数据模型
- `user`（用户表）
  - `id`(BIGINT PK), `username`(UNIQUE), `password_hash`, `email`, `avatar_url`, `role`(ENUM: ROLE_USER/ROLE_ANONYMOUS), `enabled`(BOOL), `created_at`(DATETIME)
  - 索引：`idx_username`（唯一）、`idx_created_at`
- `code_snippet`（代码片段表）
  - `id`(BIGINT PK), `user_id`(FK), `title`, `code_content`(TEXT), `language`('c'), `is_public`(BOOL), `created_at`, `updated_at`
  - 索引：`idx_user_id`、`idx_created_at`、`idx_title`
- `execution_record`（执行记录表）
  - `id`(BIGINT PK), `user_id`(FK), `title`, `code`(TEXT), `output`(TEXT), `error`(TEXT), `exit_code`(INT), `created_at`
  - 索引：`idx_user_created(user_id, created_at)`, `idx_exit_code`

## 4. 接口设计（与前端契约一致，统一 ` /api ` 前缀）
- 认证
  - `POST /api/auth/register`
    - 请求：`{ username, password, email? }`
    - 响应：`{ code, message?, data:{ accessToken, refreshToken? } }`
  - `POST /api/auth/login`
    - 请求：`{ username, password }`
    - 响应：同上
  - `GET /api/user`
    - 请求：无
    - 响应：`{ code, data:{ id, username, avatarUrl?, createdAt, email?, role } }`

- 代码
  - `POST /api/code/save`
    - 请求：`{ title, codeContent, language:'c', isPublic }`
    - 响应：`{ code, data:{ id, title, createdAt } }`
  - `POST /api/code/run`
    - 请求：`{ code, title? }`
    - 响应：`{ code, data:{ success, output, error, exitCode } }`

- 执行记录
  - `GET /api/result/list`
    - 响应：`{ code, data:[ { id, title, output, exitCode, createdAt } ] }`

- WebSocket
  - 端点：`/ws/execution-result`
  - 鉴权：握手头 `Authorization: Bearer <token>`；后端解析 JWT 绑定会话
  - 推送：`ExecutionResult` JSON `{ success, output, error, exitCode }`

## 5. 安全设计（Spring Security + JWT）
- 认证流程：
  - 登录时使用 `AuthenticationManager` 校验用户名/密码；成功后签发 `accessToken(15min)` 与可选 `refreshToken(7d)`
  - 请求经过 `JwtAuthenticationFilter`，从 `Authorization` 头解析 Bearer Token，校验签名、过期、黑名单
- 核心组件：
  - `CustomUserDetailsService`：按用户名加载用户，映射角色为 `ROLE_USER` 或 `ROLE_ANONYMOUS`
  - `JwtTokenProvider`：生成/校验/解析 JWT；含 `isTokenBlacklisted()` 检查
  - `SecurityConfig`：配置无权匿名访问的接口（登录、注册、静态资源、WS 握手可适度放行）
- 令牌黑名单：`Redis key=jwt:blacklist:<token>`，登出或强制失效时写入，过期与 access 对齐

## 6. 代码处理与执行设计
- 限制与防护：
  - 代码长度 ≤ 10KB；仅允许语言 `c`
  - 编译命令固定：`gcc -o <out> <src> -Wall -Wextra`，禁止自定义参数
  - 运行以低权限用户（如 `nobody`）执行；限制 CPU/内存/时长（ulimit/cgroup，部署侧落实）
  - 输出大小上限 1MB，超限报错
- 临时文件与隔离：
  - Linux 使用 `/dev/shm/code-env`（内存文件系统）；Windows/开发机回退至 `java.io.tmpdir`
- 异步执行：
  - `compileExecutor`、`runExecutor`、`websocketExecutor` 线程池隔离
  - `CompletableFuture` 串联编译与运行阶段
- 编译与运行超时：编译 10s、运行 5s；超时销毁进程
- 缓存：对相同代码的编译结果做 Redis 缓存（Key=SHA-256(code)），命中后可跳过编译

## 7. 服务与类设计（关键伪代码）
```java
@Service
public class CodeExecutionService {
  // 编译与运行入口，返回执行结果并通过 WS 推送
}

@Service
public class CodeSnippetService {
  // 保存/查询代码片段
}

@Service
public class AuthService {
  // 注册/登录，签发与刷新令牌
}

@Configuration
@EnableAsync
public class AsyncConfig {
  // compileExecutor / runExecutor / websocketExecutor
}

@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer { }

@Component
public class ExecutionWebSocketHandler extends TextWebSocketHandler {
  // 握手鉴权、会话管理、结果推送
}
```

## 8. 异常与返回值规范
- 全局异常处理：`@ControllerAdvice` 统一包装 `{ code, message, data }`
  - 参数校验失败：`code=400`
  - 未认证：`code=401`
  - 无权限：`code=403`
  - 业务错误：`code=422`
  - 系统错误：`code=500`
- 日志：关键路径打印 `requestId`、用户 `userId`、耗时、出口码

## 9. 性能与稳定性
- 线程池参数：根据实例规格可调，默认 `compile(3/10)、run(5/20)、ws(2/5)`
- 连接池：DataSource、HTTP 客户端合理连接上限
- 分页：`/result/list` 支持 `page/size`（后续迭代）；当前返回最近 N 条
- 重试：编译偶发失败可小次数重试（如 1 次）

## 10. 运维与配置
- 配置项（application.yml）：
  - `jwt.secret`、`jwt.access-expiration`、`jwt.refresh-expiration`
  - `datasource`（TiDB/MySQL）与连接池参数
  - `redis` 连接信息（Lettuce）
  - `code.tempDir`（默认 `/dev/shm/code-env`）
- 观测：
  - 指标：执行成功率、平均编译/运行时长、超时/失败次数
  - 日志切分：按天/文件大小滚动

## 11. 与前端对齐要点
- 路径一致：`/api/auth/*`、`/api/code/*`、`/api/result/*`
- 字段一致：`camelCase`，`ExecutionResult` 结构 `{ success, output, error, exitCode }`
- WebSocket：端点一致、握手携带 `Authorization`，断线重连友好

## 12. 后续扩展
- 匿名登录：默认 `ROLE_ANONYMOUS`，频控与权限隔离
- 刷新令牌：`POST /api/auth/refresh`，静默续期
- 沙箱强化：容器化隔离（nsjail/firejail/容器），资源配额细化
- 审计与灰度：执行动作审计、按用户/版本灰度线程池与超时参数


